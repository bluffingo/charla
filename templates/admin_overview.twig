{% extends "_layout_admin.twig" %}

{% set title = "Overview" %}

	{% block admincontent %}
        <div class="content-box">
            <div class="section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h1 class="section-title">Over the years</h1>
                        <div class="section-desc">Since {{ data.time.formatted_date }}
                            ({{ data.time.relative_days }} days ago)
                        </div>
                    </div>
                </div>
                <canvas id="cumulativeChart"></canvas>
            </div>
        </div>
        <br>
        <div class="content-box">
            <div class="section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h1 class="section-title">Server details</h1>
                    </div>
                </div>
                {% if data.system.is_windows %}
                    <div class="text-danger">
                        Windows is no longer officially supported. If you are using XAMPP, please switch to Windows
                        Subsystem for Linux.
                    </div>
                {% endif %}
                <ul>
                    {% if is_opensb_v1_3 and data.system.os_name %}
                        <li>Operating System: {{ data.system.os_name }}</li>
                    {% endif %}
                    <li>Uname: {{ data.system.uname }}</li>
                </ul>
            </div>
        </div>
        <div class="content-box no-border-top">
            <div class="section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h1 class="section-title">Statistics</h1>
                    </div>
                </div>
                <ul>
                    {% for key, number in data.numbers %}
                        <li>{{ key }}: {{ number }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% if invite_keys_enabled %}
            <div id="invitekeys" class="tabcontent">
                <div class="content-box">
                    <div class="content-box centered">
                        <form name="inviteKeyGenerationForm" id="inviteKeyGenerationForm" method="post" action="admin"
                              enctype="multipart/form-data">
                            <input type="hidden" id="action" name="action" value="generate_invite_key"/>
                            <input class="button button-primary button-huge" type="submit" id="generate" name="generate"
                                   value="Generate invite key">
                        </form>
                        <p>
                            If you give an invitation key to a bad actor, you <strong>will</strong> be demoted.
                        </p>
                    </div>
                    <br>
                    <div class="content-box">
                        <h1>All invite keys</h1>
                        <table class="c1">
                            <tr class="h">
                                <th style="width:200px">Invite Key</th>
                                <th>Generated By</th>
                                <th>Claimed By</th>
                            </tr>
                            {% for inviteKey in data.invites %}
                                <tr style="height: 30px;">
                                    <td>{{ inviteKey.invite_key }}</td>
                                    <td>
                                        {{ inviteKey.generated_by.name }}
                                        <small>({{ inviteKey.generated_time | date('F jS Y') }}
                                            /{{ inviteKey.generated_time | relative_time }})</small>
                                    </td>
                                    <td>
                                        {% if inviteKey.claimed_by %}
                                            {{ inviteKey.claimed_by.name }}
                                            <small>({{ inviteKey.claimed_time | date('F jS Y') }}
                                                /{{ inviteKey.claimed_time | relative_time }})</small>
                                        {% else %}
                                            Not claimed
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        const cumulativeChart = document.getElementById('cumulativeChart');
        const viewChart = document.getElementById('viewChart');

        /* todo: replace chart.js with anything else that can offer a zoom slider. */

        new Chart(cumulativeChart, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Uploads',
                        data: [
                            {% for graph in data.graph_data.submissions %}
                            {
                                x: "{{ graph.time }}",
                                y: {{ graph.runningTotal }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                    {
                        label: 'Users',
                        data: [
                            {% for graph in data.graph_data.users %}
                            {
                                x: "{{ graph.joined }}",
                                y: {{ graph.runningTotal }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                    {
                        label: 'Comments',
                        data: [
                            {% for graph in data.graph_data.comments %}
                            {
                                x: "{{ graph.date }}",
                                y: {{ graph.runningTotal }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                    {
                        label: 'Journals',
                        data: [
                            {% for graph in data.graph_data.journals %}
                            {
                                x: "{{ graph.date }}",
                                y: {{ graph.runningTotal }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                    {
                        label: 'Views (Logged in)',
                        data: [
                            {% for graph in data.graph_data.views %}
                            {
                                x: "{{ graph.date }}",
                                y: {{ graph.user_views }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                    {
                        label: 'Views (Guests)',
                        data: [
                            {% for graph in data.graph_data.views %}
                            {
                                x: "{{ graph.date }}",
                                y: {{ graph.guest_views }},
                            },
                            {% endfor %}
                        ],
                        borderWidth: 1
                    },
                ]
            },
            options: {
                elements: {
                    point: {
                        radius: 2
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    {% if is_chaziz_sb %}
                    x: {
                        type: 'time',
                        min: '2021-01-30 00:00:00',
                    }
                    {% else %}
                    x: {
                        type: 'time',
                    }
                    {% endif %}
                }
            }
        });
    </script>
{% endblock %}